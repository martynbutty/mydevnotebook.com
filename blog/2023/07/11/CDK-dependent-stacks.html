<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">AWS CDK dependent stacks | My Dev Notebook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="AWS CDK dependent stacks | My Dev Notebook"><meta data-rh="true" name="description" content="How to decouple dependent AWS stacks"><meta data-rh="true" property="og:description" content="How to decouple dependent AWS stacks"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-07-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/MartynButty"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks"><link data-rh="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Dev Notebook RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Dev Notebook Atom Feed">



<script src="https://www.googletagmanager.com/gtag/js?id=G-H8PHRNFHKD" async></script>
<script src="/ga.js"></script><link rel="stylesheet" href="/assets/css/styles.533a46bd.css">
<script src="/assets/js/runtime~main.ba9e2858.js" defer="defer"></script>
<script src="/assets/js/main.ac844c97.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Dev Notebook</b></a><a class="navbar__item navbar__link" href="/">Tech Articles</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/08/15/Aurora-backups">Aurora Serverless Backup Configuration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/08/01/Aurora-Serverless-database-selection">Aurora Serverless Database Selection</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2023/07/11/CDK-dependent-stacks">AWS CDK dependent stacks</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/09/06/Performance-Testing-Basics">Performance Testing Basics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/02/14/AWS-EC2-Instance-Types">AWS EC2 Instance Types</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/12/14/Docker-VPN-Network-Fix">Docker build fail with VPN</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/11/06/memory">Computer Memory Types</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/02/wsdl">WSDL Glossary</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="How to decouple dependent AWS stacks"><header><h1 class="title_f1Hy" itemprop="headline">AWS CDK dependent stacks</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-07-11T00:00:00.000Z" itemprop="datePublished">July 11, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/MartynButty" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/MartynButty.png" alt="Martyn Butterworth" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/MartynButty" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Martyn Butterworth</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Architect</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Sometimes you try deploying a change to an existing multi-stack CDK project, only to get an error message similar to &quot;<strong>Export cannot be deleted as it is in use</strong>&quot;. Read on if you&#x27;ve encountered this error and are struggling to fix it, or you&#x27;re just interested in finding out about dependent stacks in AWS.</p>
<h2 id="aws-cdk-dependent-stacks">AWS CDK dependent stacks</h2>
<p>AWS CDK makes it easy to share resources in different stacks. For example, allowing an SQS queue from one stack to be used by a lambda in a different stack. In this case, CDK automatically takes care of cross stack references, and also ensures deployments happen in the correct order.</p>
<p><img alt="CDK dependent stacks architecture" src="/assets/images/DependentStacks-299bd51aa765cfff1a7e67cd60fde1f9.png" width="623" height="301"></p>
<p>The problem you&#x27;ve probably encountered seeing as you&#x27;re here, is that you&#x27;re trying to remove  that cross stack reference, but you see  something like:
<code>Export &lt;&lt;some AWS ref&gt;&gt; cannot be deleted as it is in use by &lt;&lt;some stack&gt;&gt;</code></p>
<h2 id="how-did-this-happen">How did this happen</h2>
<p>Cross stack references occur when you have two stacks, and you share something from one stack with the other. When CDK is building the cloudFormation template, it will automatically manage these cross stack references. It does this by &quot;exporting&quot; the construct from the producing stack (using an auto generated name), and &quot;importing&quot; the construct in the consuming construct.</p>
<p>If you make a change that impacts the cross stack dependency, you can find yourself in a circular trap where CDK knows it has to deploy the producingStack first, but that fails because the existing (already deployed) version of the consuming stack still requires the exports you&#x27;re trying to remove, and it cannot deploy the consumingStack first because that depends on the producingStack.</p>
<p><img alt="CDK depent stacks deployment problem" src="/assets/images/CDK-dependent-stacks-888d3a0f1147307a15cdb30fb1c11123.png" width="432" height="323"></p>
<h2 id="example">Example</h2>
<p>Given a stack <code>producingStack</code> that creates an SQS queue, and a <code>consumingStack</code> that has a lambda function that is allowed to push messages to the SQS queue, we end up with (partial) CDK code that looks a little like below (full example code can be found <a href="https://github.com/martynbutty/cdkDependantStacks">here</a>)</p>
<pre><code class="language-typeScript">...
export class producingStack extends cdk.Stack {  
    public readonly sourceQueueArn: string;  
    public readonly sourceQueueUrl: string;  

    constructor(scope: Construct, id: string, props?: cdk.StackProps) {  
        super(scope, id, props);  

        const sourceMessageQueue = new sqs.Queue(this, &#x27;sourceMessageQueue&#x27;, {  
            queueName: &#x27;sourceMessageQueue&#x27;  
        });  

        this.sourceQueueArn = sourceMessageQueue.queueArn;  
        this.sourceQueueUrl = sourceMessageQueue.queueUrl;  
        ...
</code></pre>
<pre><code class="language-typescript">export class consumingStack extends cdk.Stack {  
    constructor(scope: Construct, id: string, props: HotelsDataAcquisitionStackProps) {  
        super(scope, id, props);  

        const queue = aws_sqs.Queue.fromQueueArn(this, &#x27;sourceQ&#x27;, props.sqsArn);  

        const eventSource = new SqsEventSource(queue, {  
            batchSize: 10,  
            reportBatchItemFailures : true,  
            enabled: true  
        });  

        const lambdaEnvVars = {  
            SQS_QUEUE_URL: props.sqsUrl  
        };  

        const processingLambda = new NodejsFunction(this, &#x27;processingLambda&#x27;, {  
            entry: &#x27;./lambda/index.ts&#x27;,  
            runtime: aws_lambda.Runtime.NODEJS_18_X,  
            handler: &#x27;main&#x27;,  
            environment: lambdaEnvVars  
        });  

        processingLambda.addEventSource(eventSource);  
    }  
}
</code></pre>
<p>We have already deployed these stacks, and are now trying to refactor our solution to remove the cross stack dependency.</p>
<h3 id="refactor-to-remove-a-dependency">Refactor to remove a dependency</h3>
<p>For this example, we&#x27;re going to simply remove the SQS URL in the lambda&#x27;s environment variable. producingStack is unchanged, and consumingStack looks like below.</p>
<blockquote>
<p>You&#x27;d normally just delete code that&#x27;s no longer required, but it&#x27;s shown commented out here to make it easier to see what&#x27;s changing.</p>
</blockquote>
<pre><code class="language-typescript">export class consumingStack extends cdk.Stack {  
    constructor(scope: Construct, id: string, props: HotelsDataAcquisitionStackProps) {  
        super(scope, id, props);  

        const queue = aws_sqs.Queue.fromQueueArn(this, &#x27;sourceQ&#x27;, props.sqsArn);  

        const eventSource = new SqsEventSource(queue, {  
            batchSize: 10,  
            reportBatchItemFailures : true,  
            enabled: true  
        });  

        // const lambdaEnvVars = {  
        // 	SQS_QUEUE_URL: props.sqsUrl
        // };  
        
        const processingLambda = new NodejsFunction(this, &#x27;processingLambda&#x27;, {  
            entry: &#x27;./lambda/index.ts&#x27;,  
            runtime: aws_lambda.Runtime.NODEJS_18_X,  
            handler: &#x27;main&#x27;
            // environment: lambdaEnvVars  
        });  

        processingLambda.addEventSource(eventSource);  
    }  
}
</code></pre>
<p>When you try to <code>cdk deploy</code> this change, you get a failure
`Stack Deployments Failed: Error: The stack named producingStack failed to deploy: UPDATE_ROLLBACK_COMPLETE</p>
<p>The cause of the rollback is output on the CLI output but it gets hidden at the end. To find it another way, you can use the AWS console -&gt; cloudformation -&gt; producingStack -&gt; events, where we see the offending error:
<code>Export producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816 cannot be deleted as it is in use by consumingStack</code></p>
<p>If we do a <code>cdk diff</code> we can see that an export is being removed</p>
<pre><code>...
Outputs
[-] Output ExportsOutputRefsourceMessageQueueE741C4AF715E0816: {&quot;Value&quot;:{&quot;Ref&quot;:&quot;sourceMessageQueueE741C4AF&quot;},&quot;Export&quot;:{&quot;Name&quot;:&quot;producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816&quot;}}
...
</code></pre>
<p>CDK automatically created this export when it first detected the cross stack dependency, and it is now attempting to remove it because of our change to consumingStack.</p>
<h4 id="what-went-wrong">What went wrong</h4>
<p>CDK knows that consumingStack depends on producingStack (for the SQS exports).  Any deploy will therefore trigger the deploy of the producingStack first, <strong>even if you try to just deploy the consumingStack</strong>.</p>
<p>In our case, we&#x27;ve only changed the consumingStack. This change means CDK notices we no longer need to &quot;export&quot; the SQS URL, so it removes that export, as can be seen in the above <code>cdk diff</code> partial output.</p>
<p>CDK tries to first apply the change to producingStack. This change is to remove the export of the SQS URL.  However, CDK notices that the currently deployed version of consumingStack still has an import on that URL (it hasn&#x27;t deployed the change to the consumingStack yet). So CDK fails the deploy and rolls-back.</p>
<h3 id="the-fix">The fix</h3>
<p>To fix this problem, we make a temporary code change in <code>producingStack</code> to explicitly export a ref to the SQS URL. This is in addition to the decoupling change we already made in <code>consumingStack</code>. This export will therefore be in the cloudformation template regardless of if it is actually used or not. To achieve this, we use the AWS CDK <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.Stack.html#exportwbrvalueexportedvalue-options"><code>exportValue()</code></a>  function. In our case, we add the below to <code>producingStack</code>:</p>
<p><code>this.exportValue(sourceMessageQueue.queueUrl);</code></p>
<blockquote>
<p>Note: If you&#x27;re observant, and wanted to completely decouple the stacks, we&#x27;d also have add another export as we also implicitly use the SQS ARN in the initial version. So you&#x27;d also add:</p>
</blockquote>
<p><code>this.exportValue(sourceMessageQueue.queueArn);</code></p>
<p>To confirm our change worked we can run another <code>cdk diff</code>. This time you should notice that the export is no longer removed (we know this by the absence of it&#x27;s removal / negating output from the diff). CDK can therefore safely deploy <code>producingStack</code> without compromising the deployed (old) version of <code>consumingStack</code>. It then deploys the new version of <code>consumingStack</code> which removes the dependency.</p>
<p>Now we managed to deploy and remove the dependency, we can make a second change to remove the temporary exports (the <code>exportValue()</code>) and redeploy again to be in a clean state. This time a <code>cdk diff</code> should show the removal of the exports, but this is on now that <code>consumingStack</code> no longer depends on the export.</p>
<h2 id="useful-commands">Useful commands</h2>
<ul>
<li>Use <code>cdk diff</code> to check for removed &quot;exports&quot;. If you see any, then retain them by manually exporting them with <code>exportValue()</code>.</li>
<li>To see if the currently deployed versions of your stacks have any exports: <code>aws cloudformation list-exports</code>. Note: you will probably always have some exports as the underlying CDK deployment framework usually creates a couple of exports.</li>
<li>You can see the exports locally in your <code>cdk.out</code> directory. For our example, look in <code>./dependantStacks/cdk.out/producingStack.template.json</code> for the <code>Outputs</code> section</li>
<li>You can see the exports in the <strong>currently deployed</strong> versions by viewing the cloudformation template in the AWS console -&gt; cloudformation -&gt; producingStack -&gt; template</li>
<li>Given an export name, you can see which stack(s) use it: <code>aws cloudformation list-imports --export-name producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816</code></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2023/08/01/Aurora-Serverless-database-selection"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Aurora Serverless Database Selection</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2022/09/06/Performance-Testing-Basics"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Performance Testing Basics</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aws-cdk-dependent-stacks" class="table-of-contents__link toc-highlight">AWS CDK dependent stacks</a></li><li><a href="#how-did-this-happen" class="table-of-contents__link toc-highlight">How did this happen</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a><ul><li><a href="#refactor-to-remove-a-dependency" class="table-of-contents__link toc-highlight">Refactor to remove a dependency</a></li><li><a href="#the-fix" class="table-of-contents__link toc-highlight">The fix</a></li></ul></li><li><a href="#useful-commands" class="table-of-contents__link toc-highlight">Useful commands</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 MyDevNotebook.com. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>