<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Dev Notebook RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Dev Notebook Atom Feed">
<script src="https://www.googletagmanager.com/gtag/js?id=G-H8PHRNFHKD" async></script>
<script src="/ga.js"></script><title data-react-helmet="true">AWS CDK export cannot be deleted as it is in use | My Dev Notebook</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="AWS CDK export cannot be deleted as it is in use | My Dev Notebook"><meta data-react-helmet="true" name="description" content="Sometimes you try deploying a change to an existing multi-stack CDK project, only to get an error message similar to &quot;Export cannot be deleted as it is in use&quot;. Read on if you&#x27;ve encountered this error and are struggling to fix it, or you&#x27;re just interested in finding out about dependent stacks in AWS."><meta data-react-helmet="true" property="og:description" content="Sometimes you try deploying a change to an existing multi-stack CDK project, only to get an error message similar to &quot;Export cannot be deleted as it is in use&quot;. Read on if you&#x27;ve encountered this error and are struggling to fix it, or you&#x27;re just interested in finding out about dependent stacks in AWS."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-07-11T00:00:00.000Z"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks"><link data-react-helmet="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2023/07/11/CDK-dependent-stacks" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c20d7478.css">
<link rel="preload" href="/assets/js/runtime~main.95de57dd.js" as="script">
<link rel="preload" href="/assets/js/main.bca77a23.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">My Dev Notebook</b></a><a class="navbar__item navbar__link" href="/">Tech Articles</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/2023/07/11/CDK-dependent-stacks">AWS CDK export cannot be deleted as it is in use</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/09/06/Performance-Testing-Basics">Performance Testing Basics</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/02/14/AWS-EC2-Instance-Types">AWS EC2 Instance Types</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/12/14/Docker-VPN-Network-Fix">Docker build fail with VPN</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/11/06/memory">Computer Memory Types</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">AWS CDK export cannot be deleted as it is in use</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-07-11T00:00:00.000Z" itemprop="datePublished">July 11, 2023</time> Â· <!-- -->6 min read</div></header><div class="markdown" itemprop="articleBody"><p>Sometimes you try deploying a change to an existing multi-stack CDK project, only to get an error message similar to &quot;<strong>Export cannot be deleted as it is in use</strong>&quot;. Read on if you&#x27;ve encountered this error and are struggling to fix it, or you&#x27;re just interested in finding out about dependent stacks in AWS.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="aws-cdk-dependent-stacks">AWS CDK dependent stacks<a aria-hidden="true" class="hash-link" href="#aws-cdk-dependent-stacks" title="Direct link to heading">â€‹</a></h2><p>AWS CDK makes it easy to share resources in different stacks. For example, allowing an SQS queue from one stack to be used by a lambda in a different stack. In this case, CDK automatically takes care of cross stack references, and also ensures deployments happen in the correct order.</p><p><img alt="CDK dependent stacks architecture" src="/assets/images/DependentStacks-299bd51aa765cfff1a7e67cd60fde1f9.png"></p><p>The problem you&#x27;ve probably encountered seeing as you&#x27;re here, is that you&#x27;re trying to remove  that cross stack reference, but you see  something like:
<code>Export &lt;&lt;some AWS ref&gt;&gt; cannot be deleted as it is in use by &lt;&lt;some stack&gt;&gt;</code></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-did-this-happen">How did this happen<a aria-hidden="true" class="hash-link" href="#how-did-this-happen" title="Direct link to heading">â€‹</a></h2><p>Cross stack references occur when you have two stacks, and you share something from one stack with the other. When CDK is building the cloudFormation template, it will automatically manage these cross stack references. It does this by &quot;exporting&quot; the construct from the producing stack (using an auto generated name), and &quot;importing&quot; the construct in the consuming construct.</p><p>If you make a change that impacts the cross stack dependency, you can find yourself in a circular trap where CDK knows it has to deploy the producingStack first, but that fails because the existing (already deployed) version of the consuming stack still requires the exports you&#x27;re trying to remove, and it cannot deploy the consumingStack first because that depends on the producingStack.</p><p><img alt="CDK depent stacks deployment problem" src="/assets/images/CDK-dependent-stacks-888d3a0f1147307a15cdb30fb1c11123.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="example">Example<a aria-hidden="true" class="hash-link" href="#example" title="Direct link to heading">â€‹</a></h2><p>Given a stack <code>producingStack</code> that creates an SQS queue, and a <code>consumingStack</code> that has a lambda function that is allowed to push messages to the SQS queue, we end up with (partial) CDK code that looks a little like below (full example code can be found <a href="https://github.com/martynbutty/cdkDependantStacks" target="_blank" rel="noopener noreferrer">here</a>)</p><div class="codeBlockContainer_J+bg language-typeScript"><div class="codeBlockContent_csEI typeScript"><pre tabindex="0" class="prism-code language-typeScript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export class producingStack extends cdk.Stack {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public readonly sourceQueueArn: string;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public readonly sourceQueueUrl: string;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor(scope: Construct, id: string, props?: cdk.StackProps) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(scope, id, props);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        const sourceMessageQueue = new sqs.Queue(this, &#x27;sourceMessageQueue&#x27;, {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            queueName: &#x27;sourceMessageQueue&#x27;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourceQueueArn = sourceMessageQueue.queueArn;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sourceQueueUrl = sourceMessageQueue.queueUrl;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg language-typescript"><div class="codeBlockContent_csEI typescript"><pre tabindex="0" class="prism-code language-typescript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">consumingStack</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">cdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Stack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Construct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">HotelsDataAcquisitionStackProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_sqs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">fromQueueArn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;sourceQ&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sqsArn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> eventSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">SqsEventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batchSize</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reportBatchItemFailures </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> lambdaEnvVars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token constant" style="color:#36acaa">SQS_QUEUE_URL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sqsUrl</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> processingLambda </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">NodejsFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;processingLambda&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            entry</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./lambda/index.ts&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runtime</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> aws_lambda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODEJS_18_X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;main&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            environment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> lambdaEnvVars  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processingLambda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We have already deployed these stacks, and are now trying to refactor our solution to remove the cross stack dependency.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="refactor-to-remove-a-dependency">Refactor to remove a dependency<a aria-hidden="true" class="hash-link" href="#refactor-to-remove-a-dependency" title="Direct link to heading">â€‹</a></h3><p>For this example, we&#x27;re going to simply remove the SQS URL in the lambda&#x27;s environment variable. producingStack is unchanged, and consumingStack looks like below. </p><blockquote><p>You&#x27;d normally just delete code that&#x27;s no longer required, but it&#x27;s shown commented out here to make it easier to see what&#x27;s changing.</p></blockquote><div class="codeBlockContainer_J+bg language-typescript"><div class="codeBlockContent_csEI typescript"><pre tabindex="0" class="prism-code language-typescript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">consumingStack</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">cdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Stack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Construct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">HotelsDataAcquisitionStackProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_sqs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">fromQueueArn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;sourceQ&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sqsArn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> eventSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">SqsEventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batchSize</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reportBatchItemFailures </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enabled</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// const lambdaEnvVars = {  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//  SQS_QUEUE_URL: props.sqsUrl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// };  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> processingLambda </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name">NodejsFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;processingLambda&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            entry</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./lambda/index.ts&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runtime</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> aws_lambda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODEJS_18_X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;main&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// environment: lambdaEnvVars  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processingLambda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When you try to <code>cdk deploy</code> this change, you get a failure
`Stack Deployments Failed: Error: The stack named producingStack failed to deploy: UPDATE_ROLLBACK_COMPLETE</p><p>The cause of the rollback is output on the CLI output but it gets hidden at the end. To find it another way, you can use the AWS console -&gt; cloudformation -&gt; producingStack -&gt; events, where we see the offending error:
<code>Export producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816 cannot be deleted as it is in use by consumingStack</code></p><p>If we do a <code>cdk diff</code> we can see that an export is being removed</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-] Output ExportsOutputRefsourceMessageQueueE741C4AF715E0816: {&quot;Value&quot;:{&quot;Ref&quot;:&quot;sourceMessageQueueE741C4AF&quot;},&quot;Export&quot;:{&quot;Name&quot;:&quot;producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816&quot;}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>CDK automatically created this export when it first detected the cross stack dependency, and it is now attempting to remove it because of our change to consumingStack.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="what-went-wrong">What went wrong<a aria-hidden="true" class="hash-link" href="#what-went-wrong" title="Direct link to heading">â€‹</a></h4><p>CDK knows that consumingStack depends on producingStack (for the SQS exports).  Any deploy will therefore trigger the deploy of the producingStack first, <strong>even if you try to just deploy the consumingStack</strong>.</p><p>In our case, we&#x27;ve only changed the consumingStack. This change means CDK notices we no longer need to &quot;export&quot; the SQS URL, so it removes that export, as can be seen in the above <code>cdk diff</code> partial output. </p><p>CDK tries to first apply the change to producingStack. This change is to remove the export of the SQS URL.  However, CDK notices that the currently deployed version of consumingStack still has an import on that URL (it hasn&#x27;t deployed the change to the consumingStack yet). So CDK fails the deploy and rolls-back.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-fix">The fix<a aria-hidden="true" class="hash-link" href="#the-fix" title="Direct link to heading">â€‹</a></h3><p>To fix this problem, we make a temporary code change in <code>producingStack</code> to explicitly export a ref to the SQS URL. This is in addition to the decoupling change we already made in <code>consumingStack</code>. This export will therefore be in the cloudformation template regardless of if it is actually used or not. To achieve this, we use the AWS CDK <a href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.Stack.html#exportwbrvalueexportedvalue-options" target="_blank" rel="noopener noreferrer"><code>exportValue()</code></a>  function. In our case, we add the below to <code>producingStack</code>:</p><p><code>this.exportValue(sourceMessageQueue.queueUrl);</code></p><blockquote><p>Note: If you&#x27;re observant, and wanted to completely decouple the stacks, we&#x27;d also have add another export as we also implicitly use the SQS ARN in the initial version. So you&#x27;d also add:</p></blockquote><p><code>this.exportValue(sourceMessageQueue.queueArn);</code></p><p>To confirm our change worked we can run another <code>cdk diff</code>. This time you should notice that the export is no longer removed (we know this by the absence of it&#x27;s removal / negating output from the diff). CDK can therefore safely deploy <code>producingStack</code> without compromising the deployed (old) version of <code>consumingStack</code>. It then deploys the new version of <code>consumingStack</code> which removes the dependency.</p><p>Now we managed to deploy and remove the dependency, we can make a second change to remove the temporary exports (the <code>exportValue()</code>) and redeploy again to be in a clean state. This time a <code>cdk diff</code> should show the removal of the exports, but this is on now that <code>consumingStack</code> no longer depends on the export.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="useful-commands">Useful commands<a aria-hidden="true" class="hash-link" href="#useful-commands" title="Direct link to heading">â€‹</a></h2><ul><li>Use <code>cdk diff</code> to check for removed &quot;exports&quot;. If you see any, then retain them by manually exporting them with <code>exportValue()</code>.</li><li>To see if the currently deployed versions of your stacks have any exports: <code>aws cloudformation list-exports</code>. Note: you will probably always have some exports as the underlying CDK deployment framework usually creates a couple of exports.</li><li>You can see the exports locally in your <code>cdk.out</code> directory. For our example, look in <code>./dependantStacks/cdk.out/producingStack.template.json</code> for the <code>Outputs</code> section</li><li>You can see the exports in the <strong>currently deployed</strong> versions by viewing the cloudformation template in the AWS console -&gt; cloudformation -&gt; producingStack -&gt; template</li><li>Given an export name, you can see which stack(s) use it: <code>aws cloudformation list-imports --export-name producingStack:ExportsOutputRefsourceMessageQueueE741C4AF715E0816</code></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/09/06/Performance-Testing-Basics"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Performance Testing Basics<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aws-cdk-dependent-stacks" class="table-of-contents__link toc-highlight">AWS CDK dependent stacks</a></li><li><a href="#how-did-this-happen" class="table-of-contents__link toc-highlight">How did this happen</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a><ul><li><a href="#refactor-to-remove-a-dependency" class="table-of-contents__link toc-highlight">Refactor to remove a dependency</a></li><li><a href="#the-fix" class="table-of-contents__link toc-highlight">The fix</a></li></ul></li><li><a href="#useful-commands" class="table-of-contents__link toc-highlight">Useful commands</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 MyDevNotebook.com. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.95de57dd.js"></script>
<script src="/assets/js/main.bca77a23.js"></script>
</body>
</html>