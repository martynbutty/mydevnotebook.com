<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Dev Notebook RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Dev Notebook Atom Feed">
<script src="https://www.googletagmanager.com/gtag/js?id=G-H8PHRNFHKD" async></script>
<script src="/ga.js"></script><title data-react-helmet="true">Docker build fail with VPN | My Dev Notebook</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.mydevnotebook.com/blog/2021/12/14/Docker-VPN-Network-Fix"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Docker build fail with VPN | My Dev Notebook"><meta data-react-helmet="true" name="description" content="A possible solution to docker build failures that require resources over a VPN"><meta data-react-helmet="true" property="og:description" content="A possible solution to docker build failures that require resources over a VPN"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-12-14T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/MartynButty"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://www.mydevnotebook.com/blog/2021/12/14/Docker-VPN-Network-Fix"><link data-react-helmet="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2021/12/14/Docker-VPN-Network-Fix" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.mydevnotebook.com/blog/2021/12/14/Docker-VPN-Network-Fix" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c20d7478.css">
<link rel="preload" href="/assets/js/runtime~main.16d7482b.js" as="script">
<link rel="preload" href="/assets/js/main.51627d1f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/notebook.png" alt="My Dev Notebook Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">My Dev Notebook</b></a><a class="navbar__item navbar__link" href="/">Tech Articles</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2022/02/14/AWS-EC2-Instance-Types">AWS EC2 Instance Types</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/2021/12/14/Docker-VPN-Network-Fix">Docker build fail with VPN</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/11/06/memory">Computer Memory Types</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/2021/10/02/wsdl">WSDL Glossary</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Docker build fail with VPN</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-12-14T00:00:00.000Z" itemprop="datePublished">December 14, 2021</time> ¬∑ <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/MartynButty" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/MartynButty.png" alt="Martyn Butterworth"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/MartynButty" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Martyn Butterworth</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Architect at OnTheBeach.com</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Docker Desktop does a great job of taking care of all the networking for you and usually <em>‚Äújust works‚Äù</em>, even if you are connected to a corporate VPN.</p><p>Sometimes you may encounter difficulties which usually manifest as the <strong>build stage failing</strong>. This can happen when part of your build process requires resources that are only available when connected via your company VPN (e.g. internal package server).</p><p><img alt="Docker VPN" src="/assets/images/Docker_VPN-06329a790d69c963ad27b786021526bf.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-problem">The Problem<a aria-hidden="true" class="hash-link" href="#the-problem" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="tldr">Tl;dr<a aria-hidden="true" class="hash-link" href="#tldr" title="Direct link to heading">‚Äã</a></h3><p>Docker may have allocated an internal network range which clashes with your VPN.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="detailed-example">Detailed example<a aria-hidden="true" class="hash-link" href="#detailed-example" title="Direct link to heading">‚Äã</a></h3><p>Your project has dependancies on an internal server which might have an IP address of <code>172.17.2.79</code>. This is a <a href="https://en.wikipedia.org/wiki/Private_network" target="_blank" rel="noopener noreferrer">private network</a>) which is only accessible while connected to the companies private VPN.
Docker has created its own internal network which is using the  <code>172.17.0.0/16</code> range of addresses.
The build process tries to access your companies private package server at <code>172.17.2.79</code>.  The process is running within the private docker network. It therefore thinks the server should be available on the local docker network. It is also unable to send any traffic via the VPN due to the overlap or clash of the network range.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="confirming-this-is-the-problem">Confirming this is the problem<a aria-hidden="true" class="hash-link" href="#confirming-this-is-the-problem" title="Direct link to heading">‚Äã</a></h2><p>To confirm the above scenario is indeed the root cause of the docker build failure, we need to compare the subnet docker is using against that in use by the VPN.
<strong>### Get Docker Network</strong>
First, list all the available docker networks</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$docker network ls</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>which should output something similar to</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">NETWORK ID     NAME      DRIVER    SCOPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ceb424d5d73d   bridge    bridge    local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ad6318517651   host      host      local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a2cfb19e8122   none      null      local</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We‚Äôre interested in the ‚Äúbridge‚Äù network, so we‚Äôll inspect it by using it‚Äôs ID:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$docker network inspect ceb424d5d73d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>which should contain something like the following in its output</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Config&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>So we know that in the above case, docker is using the network range <code>172.17.0.0/16</code>
<strong>### Get VPN Network</strong>
Next we need to find out what network the VPN is using. The below should work on a MacBook Pro or linux. If you‚Äôre running on Windows, <code>ipconfig</code> may work better.
From a terminal enter the command <code>$ifconfig</code> or <code>$netstat -i</code> and look for a <code>utun*</code> entry with an IP address. For example, doing <code>$netstat -i</code> might output:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">utun3      1500  &lt;Link#17&gt;                      2298484     0   754726     0     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">utun3      1500  172.17.144/22 172.17.146.96    2298484     -   754726     -     -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This tells us the the VPN is using the network range <code>172.17.144/22</code>.
If you can remember your <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks" target="_blank" rel="noopener noreferrer">CIDR blocks</a>, you‚Äôll see that the docker network collides with that of the VPN. This means that docker will be unable to use the VPN network to get to our internal server which has the address <code>172.17.2.79</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="docker-network-fix">Docker Network Fix<a aria-hidden="true" class="hash-link" href="#docker-network-fix" title="Direct link to heading">‚Äã</a></h2><p>To resolve the above problem, we can change the address pool used by the docker daemon.
With docker desktop, the easiest way to achieve this is to open the docker desktop dashboard (UI), click the ‚Äúsettings‚Äù gear cog in the top right of the screen to view the preferences screen. Select ‚ÄúDocker Engine‚Äù from the left hand menu, which should show some JSON config. Add the below section of config into the existing JSON config (keeping what‚Äôs already there), and click the ‚ÄúApply &amp; Restart‚Äù button</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;default-address-pools&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;base&quot;: &quot;172.240.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;size&quot;: 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now if you repeat the steps to <a href="#Get-Docker-Network">Get Docker Network</a> (note, the network ID most likely changed!), you should see that docker now uses subnet <code>172.240.0.0/24</code>, and <code>docker build</code> should now be able to complete steps such as <code>dotnet build</code> which would have previously failed to reach the internal server</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/02/14/AWS-EC2-Instance-Types"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ <!-- -->AWS EC2 Instance Types</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/11/06/memory"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Computer Memory Types<!-- --> ¬ª</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-problem" class="table-of-contents__link toc-highlight">The Problem</a><ul><li><a href="#tldr" class="table-of-contents__link toc-highlight">Tl;dr</a></li><li><a href="#detailed-example" class="table-of-contents__link toc-highlight">Detailed example</a></li></ul></li><li><a href="#confirming-this-is-the-problem" class="table-of-contents__link toc-highlight">Confirming this is the problem</a></li><li><a href="#docker-network-fix" class="table-of-contents__link toc-highlight">Docker Network Fix</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 MyDevNotebook.com. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.16d7482b.js"></script>
<script src="/assets/js/main.51627d1f.js"></script>
</body>
</html>